<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>请给我一首歌的时间</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "楷体", "KaiTi", serif;
        }
        
        body {
            overflow: hidden;
            height: 100vh;
            background-color: #fff0f3;
            transition: background 1.5s ease;
        }

        #startBtn {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 16px 32px;
            font-size: 22px;
            cursor: pointer;
            background: #FF69B4;
            color: white;
            border: none;
            border-radius: 50px;
            box-shadow: 0 5px 15px rgba(255,105,180,0.3);
            transition: all 0.3s ease;
            z-index: 9999;
        }

        #startBtn:hover {
            transform: translate(-50%, -50%) scale(1.05);
        }
        
        /* 弹幕样式 */
        .tip-window {
            position: absolute;
            padding: 10px 14px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 14px;
            font-weight: bold;
            opacity: 0;
            transform: scale(0.8);
            transition: opacity 0.6s ease, transform 0.6s ease;
            z-index: 300; /* 子弹幕在上方 */
            display: block !important;
        }

        .tip-window.show {
            opacity: 1 !important;
            transform: scale(1) !important;
        }
        
        /* 子弹幕消失动画 - 加快消失速度 */
        .tip-window.fade-out {
            transition: opacity 0.6s ease-out, transform 0.6s ease-out !important;
            opacity: 0 !important;
            transform: scale(0.5) translateY(30px) !important;
        }
        
        .miss-window {
            position: fixed;
            background-color: rgba(255,228,225,0.9);
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(255,105,180,0.35);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: scale(0.9);
            transition: all 0.8s ease;
            z-index: 200; /* 主弹幕在下方 */
            width: 500px;
            height: 250px;
        }
        
        .miss-text {
            color: #CD5C5C;
            font-size: 45px;
            font-weight: bold;
            transition: all 0.8s ease;
        }

        .decor {
            position: absolute;
            opacity: 0.6;
            pointer-events: none;
            z-index: 50;
        }

        .music-control {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #FF69B4;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 999;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <button id="startBtn">Please Give the time of a song</button>
    
    <audio id="backgroundMusic" loop>
        <source src="小宇.mp3" type="audio/mpeg">
    </audio>
     
     <div class="music-control" id="musicControl">▶</div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 音乐控制
            const music = document.getElementById('backgroundMusic');
            const musicControl = document.getElementById('musicControl');
            let isPlaying = false;
            
            function toggleMusic() {
                if (isPlaying) {
                    music.pause();
                    musicControl.textContent = '▶';
                } else {
                    music.play().then(() => {
                        musicControl.textContent = '⏸';
                    }).catch(e => console.log('音乐播放失败:', e));
                }
                isPlaying = !isPlaying;
            }
            
            musicControl.addEventListener('click', toggleMusic);
            
            // 祝福语列表（与参考图匹配）
            const tips = [
                "保持微笑呀", "每天都要元气满满", "好好爱自己", "别熬夜",
                "今天过得开心嘛", "期待下一次见面", "顺顺利利", "早点休息",
                "梦想成真", "我想你了", "所有烦恼都消失", "天冷了，多穿衣服",
                "对自己好一点~", "保持好心情", "记得吃水果", "要好好生活哦",
                "金榜题名", "多喝水哦", "今天过得开心嘛", "别熬夜晚睡"
            ];
            
            // 背景颜色列表（与参考图匹配的柔和色调）
            const bgColors = [
                "#d5f5e3", "#d6eaf8", "#fce4ec", "#fef5d4",
                "#e0f7fa", "#f8c4e4", "#ffdab9", "#fff3cd",
                "#ffe4e1", "#f0fff4", "#fff0f3", "#ffead1"
            ];
            
            const allWindows = [];
            const totalWindows = 90; // 初始爱心弹幕数量
            let hasChangedText = false;
            let bulletWindows = []; // 单独存储子弹幕，便于追踪
            
            // 创建装饰元素
            function createDecorElements() {
                const count = 15;
                for (let i = 0; i < count; i++) {
                    const decor = document.createElement('div');
                    decor.className = 'decor';
                    decor.textContent = '❀';
                    decor.style.fontSize = `${Math.random() * 15 + 10}px`;
                    decor.style.color = '#FFB6C1';
                    decor.style.left = `${Math.random() * 100}vw`;
                    decor.style.top = `${Math.random() * 100}vh`;
                    document.body.appendChild(decor);
                }
            }
            
            // 计算屏幕中心
            function getCenterPosition() {
                return {
                    x: window.innerWidth / 2,
                    y: window.innerHeight / 2
                };
            }
            
            // 爱心大小比例
            const scale = Math.min(window.innerWidth, window.innerHeight) / 42;
            
            // 计算爱心曲线上的坐标
            function getHeartCoordinates(angle) {
                const center = getCenterPosition();
                const t = angle * Math.PI / 180;
                const x = 16 * Math.pow(Math.sin(t), 3);
                const y = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
                return {
                    x: center.x + x * scale,
                    y: center.y - y * scale
                };
            }
            
            // 创建初始爱心弹幕
            function createTipWindow(angle) {
                const { x, y } = getHeartCoordinates(angle);
                const width = Math.floor(Math.random() * 30) + 75;
                const height = Math.floor(Math.random() * 20) + 55;
                
                // 确保弹幕在屏幕内
                if (x < width/2 || x > window.innerWidth - width/2 || 
                    y < height/2 || y > window.innerHeight - height/2) {
                    return;
                }
                
                const div = document.createElement('div');
                div.className = 'tip-window';
                div.style.width = `${width}px`;
                div.style.height = `${height}px`;
                div.style.left = `${x - width/2}px`;
                div.style.top = `${y - height/2}px`;
                div.style.backgroundColor = bgColors[Math.floor(Math.random() * bgColors.length)];
                div.textContent = tips[Math.floor(Math.random() * tips.length)];
                
                document.body.appendChild(div);
                allWindows.push(div);
                
                // 延迟添加出现动画
                setTimeout(() => {
                    div.classList.add('show');
                }, 50);
            }
            
            // 从主弹窗发射子弹幕
            function popFromMissWindow(missWindow) {
                const rect = missWindow.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                const popCount = 300; // 子弹幕总数
                let currentBatch = 0;
                
                // 清空之前的子弹幕数组
                bulletWindows = [];
                
                // 分批生成弹幕
                const batchSize = 20;
                const totalBatches = Math.ceil(popCount / batchSize);
                
                function sendBatch() {
                    if (currentBatch >= totalBatches) {
                        // 所有子弹幕出现后换字
                        setTimeout(() => {
                            changeMissWindowText(missWindow);
                            // 换字后触发子弹幕消失
                            setTimeout(() => {
                                fadeOutAllBulletWindows();
                            }, 1000);
                        }, 1000);
                        return;
                    }
                    
                    for (let i = 0; i < batchSize; i++) {
                        // 超出总数量则停止
                        if (bulletWindows.length >= popCount) break;
                        
                        const width = Math.floor(Math.random() * 30) + 60;
                        const height = Math.floor(Math.random() * 20) + 40;
                        
                        // 随机角度和距离（向四周发射）
                        const angle = Math.random() * Math.PI * 2;
                        const distance = Math.random() * 400 + 50;
                        const x = centerX + Math.cos(angle) * distance - width / 2;
                        const y = centerY + Math.sin(angle) * distance - height / 2;
                        
                        const div = document.createElement('div');
                        div.className = 'tip-window';
                        div.style.width = `${width}px`;
                        div.style.height = `${height}px`;
                        div.style.left = `${x}px`;
                        div.style.top = `${y}px`;
                        div.style.backgroundColor = bgColors[Math.floor(Math.random() * bgColors.length)];
                        div.textContent = tips[Math.floor(Math.random() * tips.length)];
                        // 从中心弹窗位置开始动画
                        div.style.transform = `translate(${centerX - x - width/2}px, ${centerY - y - height/2}px) scale(0)`;
                        
                        document.body.appendChild(div);
                        allWindows.push(div);
                        bulletWindows.push(div); // 单独记录子弹幕
                        
                        // 触发扩散动画
                        setTimeout(() => {
                            div.classList.add('show');
                            div.style.transform = 'scale(1)';
                        }, 50);
                    }
                    
                    currentBatch++;
                    setTimeout(sendBatch, 150);
                }
                
                // 开始发射弹幕
                sendBatch();
            }
            
            // 主弹窗换字函数
            function changeMissWindowText(missWindow) {
                if (hasChangedText) return;
                hasChangedText = true;
                
                const textElement = missWindow.querySelector('.miss-text');
                textElement.style.opacity = '0';
                textElement.style.transform = 'scale(0.9)';
                
                setTimeout(() => {
                    textElement.textContent = '该睡觉了傻瓜';
                    textElement.style.color = '#FF69B4';
                    textElement.style.opacity = '1';
                    textElement.style.transform = 'scale(1)';
                    textElement.classList.add('pulse');
                }, 400);
            }
            
            // 子弹幕全部消失（核心优化）
            function fadeOutAllBulletWindows() {
                const totalBullets = bulletWindows.length;
                let removedCount = 0;
                
                // 为每个子弹幕设置消失动画
                bulletWindows.forEach((win, index) => {
                    // 随机延迟，0-2秒内全部开始消失
                    const delay = Math.random() * 2000;
                    
                    setTimeout(() => {
                        win.classList.add('fade-out');
                        
                        // 动画结束后强制移除
                        setTimeout(() => {
                            if (win.parentNode) {
                                win.parentNode.removeChild(win);
                            }
                            removedCount++;
                            
                            // 检查是否所有子弹幕都已移除
                            if (removedCount === totalBullets) {
                                // 最后再强制清理一次，确保没有残留
                                cleanupRemainingBullets();
                            }
                        }, 600); // 与动画时间匹配
                    }, delay);
                });
                
                // 额外保险：5秒后无论如何都强制清理所有子弹幕
                setTimeout(cleanupRemainingBullets, 5000);
            }
            
            // 强制清理残留的子弹幕
            function cleanupRemainingBullets() {
                // 从DOM中移除所有剩余的子弹幕
                bulletWindows.forEach(win => {
                    if (win.parentNode) {
                        win.parentNode.removeChild(win);
                    }
                });
                // 清空数组
                bulletWindows = [];
                // 也清理主数组中的引用
                const initialWindows = allWindows.slice(0, totalWindows);
                allWindows.length = 0;
                allWindows.push(...initialWindows);
            }
            
            // 初始爱心弹幕消失函数
            function fadeOutInitialWindows(callback) {
                let completed = 0;
                const total = allWindows.length;
                
                if (total === 0 && callback) {
                    callback();
                    return;
                }
                
                allWindows.forEach(win => {
                    const delay = Math.random() * 4000;
                    
                    setTimeout(() => {
                        win.style.opacity = '0';
                        win.style.transform = 'scale(0.5)';
                        
                        setTimeout(() => {
                            win.remove();
                            if (++completed === total && callback) {
                                callback();
                            }
                        }, 800);
                    }, delay);
                });
            }
            
            // 显示中心主弹幕
            function showMissYouWindow() {
                const center = getCenterPosition();
                const div = document.createElement('div');
                div.className = 'miss-window';
                div.style.left = `${center.x - 250}px`;
                div.style.top = `${center.y - 125}px`;
                
                const text = document.createElement('div');
                text.className = 'miss-text';
                text.textContent = '我好想你';
                div.appendChild(text);
                document.body.appendChild(div);
                window.missWindow = div;
                
                // 弹窗渐入动画
                setTimeout(() => {
                    div.style.opacity = '0.97';
                    div.style.transform = 'scale(1)';
                    // 弹窗显示后开始扩散弹幕
                    setTimeout(() => popFromMissWindow(div), 500);
                }, 100);
                
                // 点击交互
                div.addEventListener('click', () => {
                    const textElement = div.querySelector('.miss-text');
                    textElement.style.opacity = '0.6';
                    setTimeout(() => {
                        textElement.style.opacity = '1';
                    }, 300);
                });
            }
            
            // 关闭初始爱心弹幕
            function closeInitialWindows() {
                let completed = 0;
                const total = allWindows.length;
                
                allWindows.forEach(win => {
                    setTimeout(() => {
                        win.style.opacity = '0';
                        setTimeout(() => {
                            win.remove();
                            if (++completed === total) {
                                allWindows.length = 0;
                                showMissYouWindow();
                            }
                        }, 800);
                    }, Math.random() * 1000);
                });
            }
            
            // 初始化函数
            function init() {
                createDecorElements();
                toggleMusic();
                
                let angleStep = 360 / totalWindows;
                let currentAngle = 0;
                
                function createNextWindow() {
                    if (allWindows.length < totalWindows) {
                        const randomAngle = currentAngle + (Math.random() * 4 - 2);
                        createTipWindow(randomAngle);
                        currentAngle += angleStep;
                        // 控制生成速度
                        const delay = Math.random() * 50 + 100;
                        setTimeout(createNextWindow, delay);
                    } else {
                        // 全部创建完成后关闭初始弹幕
                        setTimeout(closeInitialWindows, 5200);
                    }
                }
                
                createNextWindow();
            }
            
            // 绑定开始按钮
            document.getElementById('startBtn').addEventListener('click', () => {
                const startBtn = document.getElementById('startBtn');
                startBtn.style.opacity = '0';
                setTimeout(() => {
                    startBtn.remove();
                    init();
                }, 300);
            });
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>请给我一首歌的时间</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "楷体", "KaiTi", serif;
        }
        
        body {
            overflow: hidden;
            height: 100vh;
            background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
            transition: background 1.5s ease;
        }

        #startBtn {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 16px 32px;
            font-size: 22px;
            cursor: pointer;
            background: #FF69B4;
            color: white;
            border: none;
            border-radius: 50px;
            box-shadow: 0 5px 15px rgba(255,105,180,0.3);
            transition: all 0.3s ease;
            z-index: 9999;
        }

        #startBtn:hover {
            transform: translate(-50%, -50%) scale(1.05);
        }
        
        /* 关键修复：确保弹幕样式强制生效 */
        .tip-window {
            position: absolute;
            padding: 12px 15px;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            font-size: 14px;
            font-weight: bold;
            opacity: 0;
            transform: scale(0.8);
            /* 明确过渡属性，避免冲突 */
            transition: opacity 0.6s ease, transform 0.6s ease;
            z-index: 300;
            /* 强制显示，防止被隐藏 */
            display: block !important;
        }

        .tip-window.show {
            opacity: 1 !important;
            transform: scale(1) !important;
        }
        
        .miss-window {
            position: fixed;
            background-color: #FFE4E1;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(255,105,180,0.35);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: scale(0.9);
            transition: all 0.8s ease;
            z-index: 200;
            width: 500px;
            height: 250px;
        }
        
        .miss-text {
            color: #CD5C5C;
            font-size: 45px;
            font-weight: bold;
            transition: all 0.8s ease;
        }

        .decor {
            position: absolute;
            opacity: 0.6;
            pointer-events: none;
            z-index: 50;
        }

        .music-control {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #FF69B4;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 999;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>
    <button id="startBtn">Please Give the time of a song</button>
    
    <audio id="backgroundMusic" loop>
        <source src="iloveyou.mp3" type="audio/mpeg">
    </audio>
     
     <div class="music-control" id="musicControl">▶</div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 音乐控制（移除alert避免阻塞弹幕）
            const music = document.getElementById('backgroundMusic');
            const musicControl = document.getElementById('musicControl');
            let isPlaying = false;
            
            function toggleMusic() {
                if (isPlaying) {
                    music.pause();
                    musicControl.textContent = '▶';
                } else {
                    music.play().then(() => {
                        musicControl.textContent = '⏸';
                    }).catch(e => console.log('音乐播放失败:', e));
                }
                isPlaying = !isPlaying;
            }
            
            musicControl.addEventListener('click', toggleMusic);
            
            // 祝福语列表
            const tips = [
                "保持微笑呀", "每天都要元气满满", "好好爱自己", "别熬夜",
                "今天过得开心嘛", "期待下一次见面", "顺顺利利", "早点休息"
            ];
            
            // 背景颜色列表
            const bgColors = [
                "#d5f5e3", "#d6eaf8", "#fce4ec", "#fef5d4",
                "#e0f7fa", "#f8c4e4", "#ffdab9"
            ];
            
            const allWindows = [];
            const totalInitialWindows = 80; // 减少初始弹幕数量，避免阻塞
            let hasChangedText = false;
            
            // 创建装饰元素
            function createDecorElements() {
                const count = 10;
                for (let i = 0; i < count; i++) {
                    const decor = document.createElement('div');
                    decor.className = 'decor';
                    decor.textContent = '❀';
                    decor.style.fontSize = `${Math.random() * 15 + 10}px`;
                    decor.style.color = '#FF69B4';
                    decor.style.left = `${Math.random() * 100}vw`;
                    decor.style.top = `${Math.random() * 100}vh`;
                    document.body.appendChild(decor);
                }
            }
            
            // 计算屏幕中心
            function getCenterPosition() {
                return {
                    x: window.innerWidth / 2,
                    y: window.innerHeight / 2
                };
            }
            
            // 调整爱心比例（关键：确保弹幕在屏幕内）
            const scale = Math.min(window.innerWidth, window.innerHeight) / 30;
            
            // 计算爱心曲线上的坐标
            function getHeartCoordinates(angle) {
                const center = getCenterPosition();
                const t = angle * Math.PI / 180;
                const x = 16 * Math.pow(Math.sin(t), 3);
                const y = 13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t);
                return {
                    x: center.x + x * scale,
                    y: center.y - y * scale
                };
            }
            
            // 创建初始心形弹幕（增加可见性检查）
            function createTipWindow(angle) {
                const { x, y } = getHeartCoordinates(angle);
                const width = Math.floor(Math.random() * 30) + 60;
                const height = Math.floor(Math.random() * 20) + 40;
                
                // 确保弹幕在屏幕可视范围内
                if (x < width/2 || x > window.innerWidth - width/2 || 
                    y < height/2 || y > window.innerHeight - height/2) {
                    return;
                }
                
                const div = document.createElement('div');
                div.className = 'tip-window';
                div.style.width = `${width}px`;
                div.style.height = `${height}px`;
                div.style.left = `${x - width/2}px`;
                div.style.top = `${y - height/2}px`;
                div.style.backgroundColor = bgColors[Math.floor(Math.random() * bgColors.length)];
                div.textContent = tips[Math.floor(Math.random() * tips.length)];
                
                document.body.appendChild(div);
                allWindows.push(div);
                
                // 立即显示弹幕（无延迟）
                setTimeout(() => {
                    div.classList.add('show');
                }, 10);
            }
            
            // 从中心弹窗发散弹幕（可视化更强）
            function popFromMissWindow(missWindow) {
                const rect = missWindow.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                const popCount = 300; // 减少数量，确保渲染
                
                // 分批生成，每批20个，避免阻塞
                const batchSize = 20;
                const totalBatches = Math.ceil(popCount / batchSize);
                
                for (let batch = 0; batch < totalBatches; batch++) {
                    setTimeout(() => {
                        for (let i = 0; i < batchSize; i++) {
                            const width = Math.floor(Math.random() * 30) + 60;
                            const height = Math.floor(Math.random() * 20) + 40;
                            
                            // 随机方向和距离（从中心向外扩散）
                            const angle = Math.random() * Math.PI * 2;
                            const distance = Math.random() * 400 + 50;
                            const x = centerX + Math.cos(angle) * distance - width / 2;
                            const y = centerY + Math.sin(angle) * distance - height / 2;
                            
                            const div = document.createElement('div');
                            div.className = 'tip-window';
                            div.style.width = `${width}px`;
                            div.style.height = `${height}px`;
                            div.style.left = `${x}px`;
                            div.style.top = `${y}px`;
                            div.style.backgroundColor = bgColors[Math.floor(Math.random() * bgColors.length)];
                            div.textContent = tips[Math.floor(Math.random() * tips.length)];
                            // 从中心弹窗位置开始动画
                            div.style.transform = `translate(${centerX - x - width/2}px, ${centerY - y - height/2}px) scale(0)`;
                            
                            document.body.appendChild(div);
                            allWindows.push(div);
                            
                            // 触发扩散动画
                            setTimeout(() => {
                                div.classList.add('show');
                                div.style.transform = 'scale(1)';
                                
                                // 检查是否覆盖弹窗，切换文字
                                if (!hasChangedText) {
                                    const missRect = missWindow.getBoundingClientRect();
                                    const divRect = div.getBoundingClientRect();
                                    const isOverlap = !(
                                        missRect.right < divRect.left ||
                                        missRect.left > divRect.right ||
                                        missRect.bottom < divRect.top ||
                                        missRect.top > divRect.bottom
                                    );
                                    if (isOverlap) {
                                        hasChangedText = true;
                                        const textElement = missWindow.querySelector('.miss-text');
                                        textElement.textContent = '我喜欢你';
                                        textElement.style.color = '#FF69B4';
                                        textElement.classList.add('pulse');
                                    }
                                }
                            }, 50);
                        }
                    }, batch * 150); // 每批间隔150ms，确保流畅显示
                }
            }
            
            // 关闭初始弹幕
            function closeInitialWindows() {
                let completed = 0;
                const total = allWindows.length;
                
                allWindows.forEach(win => {
                    setTimeout(() => {
                        win.style.opacity = '0';
                        setTimeout(() => {
                            win.remove();
                            if (++completed === total) {
                                allWindows.length = 0;
                                showMissYouWindow(); // 初始弹幕消失后显示中心弹窗
                            }
                        }, 800);
                    }, Math.random() * 1000);
                });
            }
            
            // 显示中心弹窗
            function showMissYouWindow() {
                document.body.style.background = "linear-gradient(135deg, #fff0f3 0%, #ffe4e1 100%)";
                
                const center = getCenterPosition();
                const div = document.createElement('div');
                div.className = 'miss-window';
                div.style.left = `${center.x - 250}px`;
                div.style.top = `${center.y - 125}px`;
                
                const text = document.createElement('div');
                text.className = 'miss-text';
                text.textContent = '我好想你';
                div.appendChild(text);
                document.body.appendChild(div);
                window.missWindow = div;
                
                // 弹窗渐入动画
                setTimeout(() => {
                    div.style.opacity = '0.97';
                    div.style.transform = 'scale(1)';
                    // 弹窗显示后立即开始发散弹幕
                    setTimeout(() => popFromMissWindow(div), 500);
                }, 100);
            }
            
            // 初始化函数
            function init() {
                createDecorElements();
                toggleMusic();
                
                let angleStep = 360 / totalInitialWindows;
                let currentAngle = 0;
                
                // 生成初始心形弹幕
                function createNextWindow() {
                    if (allWindows.length < totalInitialWindows) {
                        const randomAngle = currentAngle + (Math.random() * 4 - 2);
                        createTipWindow(randomAngle);
                        currentAngle += angleStep;
                        setTimeout(createNextWindow, 30); // 适中的生成速度
                    } else {
                        // 初始弹幕显示3秒后关闭
                        setTimeout(closeInitialWindows, 3000);
                    }
                }
                
                createNextWindow();
            }
            
            // 绑定开始按钮
            document.getElementById('startBtn').addEventListener('click', () => {
                const startBtn = document.getElementById('startBtn');
                startBtn.style.opacity = '0';
                setTimeout(() => {
                    startBtn.remove();
                    init();
                }, 300);
            });
        });
    </script>
</body>
</html>
